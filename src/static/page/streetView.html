<!DOCTYPE html>
<html>
  <head>
      <!-- Watanabe -->
    <title>Overlays Within Street View</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcUv44NbZm-6GfoysiQ9fx2F_R7Z4Q6zI&callback=initMap&libraries=&v=weekly"
      defer
    ></script>
     <!-- 2020/09/04 Ryo Omae -->
    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-database.js"></script>
  
    // TODO: Replace the following with your app's Firebase project configuration

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyD6VaOrWy9iANa9hJymbptL7YDC7PKZ6hM",
    authDomain: "rakuten-intern2020-b5.firebaseapp.com",
    databaseURL: "https://rakuten-intern2020-b5.firebaseio.com",
    projectId: "rakuten-intern2020-b5",
    storageBucket: "rakuten-intern2020-b5.appspot.com",
    messagingSenderId: "677223095236",
    appId: "1:677223095236:web:683056011b10dc74c5e291"
  };

  // Initialize Firebase
  //Meisho.K 2020/9/07
  firebase.initializeApp(firebaseConfig);
  var DataBase = firebase.database();
</script>


    <style type="text/css">
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }

      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #floating-panel {
        position: absolute;
        top: 10px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: "Roboto", "sans-serif";
        line-height: 30px;
        padding-left: 10px;
      }

      #floating-panel {
        margin-left: -100px;
      }
    </style>
    <script>
      "use strict";

      var panorama;
      let user_markers=[];
      let content_markers = [];
      var map;
      var PinIsVisible=true;
      var response;

      // userid, roomidをGETパラメータで送ってもらう
      // Ryo Omae
      var params = (new URL(document.location)).searchParams;
      var userId = params.get('userid');
      var roomId = params.get('roomid');
      var username = params.get('username');
      var start_lat = params.get('start_lat');
      var start_lng = params.get('start_lng');
      
      // テスト用
      roomId = '-MGa9n3IJ3iSSfMQ0vIl';
      start_lat = 135;
      start_lng = 35;
      // ここまで

      
      function initMap() {
        const astorPlace = {
            lat: start_lat,
            lng: start_lng
        }; // Set up the map
        console.log(astorPlace)
        map = new google.maps.Map(document.getElementById('map'), {
        center: astorPlace,
        zoom: 18,
        streetViewControl: true,
        });

        const busMarker = new google.maps.Marker({
          position: {
            lat: 42.345,
            lng: -71.098
          },
          map,
          icon:
            "../img/tokyo_2021.png",
          title: "Bus Stop",
          url:'https://www.rakuten.co.jp/'
        }); // We get the map's default panorama and set up some defaults.
        // Note that we don't yet set it visible.
        content_markers.push(busMarker);


        panorama = map.getStreetView();
        panorama.setPosition(astorPlace);
        panorama.setPov(
          /** @type {google.maps.StreetViewPov} */
          {
            heading: 265,
            pitch: 0
          }
        );
        panorama.setVisible(true);

        //Meisho.K 2020/09/07
        //座標の移動に応じてdbに座標を更新する処理
        panorama.addListener("position_changed", () => {
        const tmp_position = panorama.getPosition();
        const tmp_lat = tmp_position.lat()
        const tmp_lng = tmp_position.lng()
        console.log(tmp_lat)
        var roomRef = DataBase.ref("room/"+roomId+"/"+userId)
        roomRef.update({
        userid: 888888888,
        name: "Meisho Kanaomi",
        lat: tmp_lat,
        lng: tmp_lng
        })
    });
      }
      

    </script>
  </head>
  <body>
    <div id="floating-panel">
      <input
        type="button"
        value="Toggle Street View"
        onclick="toggleStreetView();"
      />
      <input
        type="button"
        value="Toggle Pins"
        onclick="togglePins();"
      />
    </div>
    <div id="map"></div>

   
<!-- 2020/09/07 Meisho.K -->
<script src = "../js/map_setting.js"></script>
<script src = "../js/room.js"></script>
<script src = "../js/user.js"></script>
<script src = "../js/content.js"></script>

<!-- 2020/09/07 Ryota Watanabe-->
<script>
  var contentRef=getContent(DataBase);
  var contentData;
  var contentTempData;
  //DBが更新されたときに呼び出される(更新処理に使う)
  contentRef.once('value',function(snapshot){
      contentTempData = snapshot.val();
      SetContentMarkers(contentTempData);
  })
  contentRef.on('value', function(snapshot) {
      deleteMarkers();
      contentData = snapshot.val()
      SetContentMarkers(contentData);
  })
</script>
<!--処理系は以下に書く-->
<script>
  // Ryo Omae
  var roomRef = DataBase.ref('room/'+roomId);
  roomRef.on('value').then(function(snapshot){
    userData = snapshot.val();
    console.log('userdata', userData);
  var userData
    var userKeyList = Object.keys(userData);
    userKeyList = userKeyList.filter(n => n != "roomid");
    // console.log(userKeyList);
    var userList=[];

    deleteMarkers(user_markers);

    userKeyList.forEach(element => {
      marker = new google.maps.Marker({
          position: {
            lat: userList[element]['lat'],
            lng: userList[element]['lng']
          },
          map,
          icon:
            "../../img/tokyo_2021.png",
        });
      user_markers.push(marker);
    });
    setMapOnAll(map, user_markers);
    })
    
    //ToDo: googlemapsにタグの更新 
    //contentList = getContent
    //Meisho Kanaomi　2020/09/04
    //urlを埋め込む
    for(let i=0; i<content_markers.length; i++){
                console.log(content_markers[i]);
                google.maps.event.addListener(content_markers[i], 'click', (function(url){
            return window.open(content_markers[i].url);}))}
    //updatePosition(database, name, roomId, userId)

</script>
</body>
</html>